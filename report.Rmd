---
title: "COVID-MS"
author: "Tim Schatto-Eckrodt"
output: 
    html_document:
      css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, echo=FALSE}
options(stringsAsFactors=FALSE)
library(readr)
library(magrittr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(scales)
library(reactable)
library(stringr)
library(lubridate)
library(openxlsx)

list.age_means <- list(
  "A00-A04"=mean(0:4),
  "A05-A14"=mean(5:14),
  "A15-A34"=mean(15:34),
  "A35-A59"=mean(35:59),
  "A60-A79"=mean(60:79),
  "A80+"=mean(80:99)
)

county_list <- stringr::str_split(unlist(lapply(stringr::str_split(list.files("meta_data"), "\\."), function(x) {if (x[2] == "json") {x[1]}})), "_")
county_list <- unique(unlist(lapply(county_list, `[`, 1)))

county_id_list <- c()
population_list <- c()
cases7_per_100k_list <- c()
county_name_list <- c()
last_updated_list <- c()
for (county in county_list) {
    if (county != "RKI") {
    meta_json <- jsonlite::read_json(paste0("meta_data/", county, "_meta.json"))
    population <- meta_json$features[[1]]$attributes$EWZ
    cases7_per_100k <- meta_json$features[[1]]$attributes$cases7_per_100k
    county_name <- meta_json$features[[1]]$attributes$county
    last_updated <- meta_json$features[[1]]$attributes$last_update
    last_updated <- substr(last_updated, 1, 10)
    
    county_id_list <- c(county_id_list, county)
    population_list <- c(population_list, population)
    cases7_per_100k_list <- c(cases7_per_100k_list, cases7_per_100k)
    county_name_list <- c(county_name_list, county_name)
    last_updated_list <- c(last_updated_list, last_updated)
    }
}
df.meta <- data.frame(
  "county_id" = county_id_list,
  "county_name" = county_name_list,
  "population" = population_list,
  "cases7_per_100k" = cases7_per_100k_list,
  "last_updated" = last_updated_list
)

RKI_COVID19 <- read_csv("meta_data/RKI_COVID19.csv")

df <- RKI_COVID19 %>% 
    filter(IdLandkreis %in% df.meta$county_id) %>% 
    mutate(Meldedatum = lubridate::parse_date_time(Meldedatum, "%Y/%m/%d %H:%M:%S")) %>% 
    mutate(Meldedatum_date = lubridate::date(Meldedatum)) %>% 
    filter(NeuerFall >= 0) %>% 
    dplyr::group_by(Meldedatum_date, Landkreis) %>% 
    summarise(
        cases = sum(AnzahlFall),
        deaths = sum(AnzahlTodesfall),
        recovered = sum(AnzahlGenesen),
        .groups = "drop"
    ) %>% 
    rename(county_name = Landkreis) %>% 
    select(
        county_name,
        Meldedatum_date,
        cases,
        deaths,
        recovered
    )

df <- left_join(
  data.frame(
    Meldedatum_date = seq(
      min(df$Meldedatum_date), 
      max(df$Meldedatum_date), 
      by="days")) %>% 
      dplyr::slice(rep(1:n(), length(df.meta$county_id))) %>% 
      arrange(Meldedatum_date) %>% 
      mutate(county_name = rep(
        df.meta$county_name, 
        n()/length(df.meta$county_id))), 
  df, 
  by = c("Meldedatum_date", "county_name")) %>% 
    mutate(across(where(is.numeric), ~ tidyr::replace_na(.x, 0))) %>% 
    left_join(df.meta, by = c("county_name")) %>% 
    mutate(population = as.numeric(population)) %>% 
    group_by(county_name) %>% 
    arrange(Meldedatum_date) %>% 
    mutate(i = zoo::rollsum(cases, k = 7, align = "right", fill = 0)) %>% 
    mutate(i = (i/population)*100000) %>% 
    mutate(across(c(cases, deaths, recovered), cumsum, .names = "{col}_kum")) %>% 
    arrange(desc(Meldedatum_date)) %>% 
    ungroup() %>% 
    rename(sieben_tage_inzidenz = i)


df.meta <- df.meta %>% 
    left_join(
        df %>% 
            group_by(county_name) %>% 
            summarise(
                total_cases = sum(cases), 
                total_deceased = sum(deaths), 
                total_recovered = sum(recovered)
            ),
        by = "county_name"
    ) %>% 
    mutate(
        current_cases = total_cases - (total_deceased + total_recovered),
        case_rate_percent = (current_cases/population)*100,
        death_rate_percent = (total_deceased/total_cases)*100
    )

total_cases <- df.meta[df.meta$county_name == "SK Münster", "total_cases"]
total_deceased <- df.meta[df.meta$county_name == "SK Münster", "total_deceased"]
total_recovered <- df.meta[df.meta$county_name == "SK Münster", "total_recovered"]
current_cases <- df.meta[df.meta$county_name == "SK Münster", "current_cases"]
case_rate_percent <- df.meta[df.meta$county_name == "SK Münster", "case_rate_percent"]
death_rate_percent <- df.meta[df.meta$county_name == "SK Münster", "death_rate_percent"]

fig.inzidenz <- df %>% 
    rename(Datum = Meldedatum_date) %>%
    mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
    ggplot(aes(x = Datum, y = sieben_tage_inzidenz, color = county_name)) +
    geom_hline(yintercept = 100, color = "#bf0000", size = 0.25) +
    geom_hline(yintercept = 50, color = "#bf0000", size = 0.25) +
    geom_hline(yintercept = 35, color = "#bf0000", size = 0.25) +
    geom_line() +
    labs(
        title = "7-Tage-Inzidenz über Zeit",
        y = "7-Tage-Inzidenz",
        x = "Datum",
        color = ""
    ) +
    theme_minimal()

fig.cases <- df %>% 
    filter(county_name == "SK Münster") %>% 
    pivot_longer(ends_with("_kum")) %>% 
    mutate(name = factor(
        name, 
        levels = c("cases_kum", "recovered_kum", "deaths_kum"),
        labels = c("Fälle", "Genesen", "Verstorben")
    )) %>% 
    rename(Datum = Meldedatum_date) %>%
    mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
    ggplot(aes(x = Datum, y = value, fill = name)) +
    geom_area(position = position_dodge(width = 1)) +
    scale_fill_manual(values = c("#e41a1c", "#4daf4a", "black")) +
    labs(
        title = "Kumulierte Fälle in Münster über Zeit",
        y = "Kumulierte Fälle",
        x = "Datum",
        fill = ""
    ) +
    theme_minimal()


df.groups <- RKI_COVID19 %>% 
    filter(IdLandkreis %in% df.meta$county_id) %>% 
    mutate(Meldedatum = lubridate::parse_date_time(Meldedatum, "%Y/%m/%d %H:%M:%S")) %>% 
    mutate(Meldedatum_month = paste(
        lubridate::year(Meldedatum), 
        stringr::str_pad(lubridate::month(Meldedatum), 2, "0", side = "left"),
        sep = "_")) %>% 
    filter(NeuerFall >= 0) %>% 
    select(Meldedatum_month, Landkreis, Geschlecht, Altersgruppe, AnzahlFall) %>% 
    pivot_longer(c(Geschlecht, Altersgruppe)) %>% 
    slice(rep(1:n(), .$AnzahlFall)) %>%
    dplyr::group_by(Meldedatum_month, Landkreis) %>% 
    count(value) %>% 
    mutate(total = sum(n)/2) %>% 
    mutate(p = n/total) %>% 
    ungroup() %>% 
    rename(county_name = Landkreis) %>% 
    left_join(df.meta, by = "county_name") %>% 
    mutate(n_100k = (n/as.numeric(population))*100000)

fig.age_groups <- df.groups %>% 
    #filter(county_name == "SK Münster") %>% 
    filter(value != "unbekannt") %>% 
    filter(!(value %in% c("M", "W"))) %>% 
    mutate(Meldedatum_month = as.POSIXct(as.Date(lubridate::parse_date_time(Meldedatum_month, "%Y_%m")))) %>%
    mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
    ggplot(aes(x = Meldedatum_month, y = n_100k, fill = value)) +
    facet_grid(rows = vars(county_name)) +
    geom_area() +
    #scale_x_datetime() +
    scale_fill_brewer(palette = "Dark2") +
    labs(
        title = "Inzidenz nach Altersgruppen über Zeit",
        y = "Fälle pro 100.000 Einwohner",
        x = "Datum",
        fill = ""
    ) +
    theme_minimal()

fig.mean_age <- RKI_COVID19 %>% 
    mutate(Meldedatum = lubridate::parse_date_time(Meldedatum, "%Y/%m/%d %H:%M:%S")) %>% 
    mutate(Meldedatum_month = paste(
        lubridate::year(Meldedatum), 
        stringr::str_pad(lubridate::month(Meldedatum), 2, "0", side = "left"),
        sep = "_")) %>% 
    mutate(Meldedatum_month = as.POSIXct(as.Date(lubridate::parse_date_time(Meldedatum_month, "%Y_%m")))) %>%
    filter(NeuerFall >= 0) %>% 
    select(Meldedatum, Altersgruppe, AnzahlFall) %>% 
    filter(Altersgruppe != "unbekannt") %>% 
    slice(rep(1:n(), .$AnzahlFall)) %>%
    mutate(Altersgruppe_num = unlist(lapply(Altersgruppe, function(x) {list.age_means[[x]]}))) %>% 
    select(Meldedatum, Altersgruppe_num) %>% 
    group_by(Meldedatum) %>% 
    summarise(y = mean(Altersgruppe_num), n = n()) %>% 
    ungroup() %>% 
    filter(n > 100) %>% 
    ggplot(aes(x = Meldedatum, y = y, group = 1)) +
    geom_line() +
    scale_x_datetime() +
    labs(
        title = "Geschätzes Durchschnittsalter der Infizierten über Zeit",
        y = "Alter",
        x = "Datum",
        fill = ""
    ) +
    theme_minimal()

fig.gender <- df.groups %>% 
    filter(value != "unbekannt") %>% 
    filter((value %in% c("M", "W"))) %>% 
    mutate(Meldedatum_month = as.POSIXct(as.Date(lubridate::parse_date_time(Meldedatum_month, "%Y_%m")))) %>%
    mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
    ggplot(aes(x = Meldedatum_month, y = n_100k, fill = value)) +
    facet_grid(rows = vars(county_name)) +
    geom_bar(stat = "identity", position = position_stack()) +
    geom_crossbar(aes(
        y = ((total/population)*100000)/2, 
        xmin = Meldedatum_month - 10, 
        xmax = Meldedatum_month + 10),
        size = .25
    ) +
    scale_x_datetime() +
    scale_fill_manual(values = c("#66a61e", "#7570b3")) +
    labs(
        title = "Inzidenz nach Geschlecht über Zeit",
        y = "Fälle pro 100.000 Einwohner",
        x = "Datum (Monat)",
        fill = ""
    ) +
    theme_minimal()

fig.gender <- RKI_COVID19 %>% 
    mutate(Meldedatum = lubridate::parse_date_time(Meldedatum, "%Y/%m/%d %H:%M:%S")) %>% 
    mutate(Meldedatum_week = paste(
        lubridate::year(Meldedatum), 
        stringr::str_pad(lubridate::week(Meldedatum)-1, 2, "0", side = "left"),
        "0",
        sep = "_")) %>% 
    mutate(Meldedatum_week = as.POSIXct(lubridate::parse_date_time(Meldedatum_week, "%Y_%U_%w"))) %>%
    filter(NeuerFall >= 0) %>% 
    select(Meldedatum_week, Geschlecht, AnzahlFall) %>% 
    filter(Geschlecht != "unbekannt") %>% 
    group_by(Meldedatum_week, Geschlecht) %>% 
    summarise(n = sum(AnzahlFall)) %>% 
    ungroup() %>% 
    group_by(Meldedatum_week) %>% 
    mutate(p = n/sum(n), total = sum(n)) %>% 
    ungroup() %>% 
    filter(n > 100) %>% 
    ggplot(aes(x = Meldedatum_week, y = p, color = Geschlecht)) +
    geom_line() +
    scale_x_datetime() +
    scale_y_continuous(labels = scales::percent) +
    scale_color_manual(values = c("#66a61e", "#7570b3")) +
    labs(
        title = "Verteilung des Geschlechts der Infizierten über Zeit",
        y = "%",
        x = "Datum (Woche)",
        color = ""
    ) +
    theme_minimal()
```

Das RKI meldet eine 7-Tage-Inzidenz für Münster von ```r round(as.numeric(df.meta[df.meta$county_name == "SK Münster", "cases7_per_100k"]), 2)```. Es sind gerade etwa ```r current_cases```[^note_estimated] Personen an COVID-19 erkrankt (etwa ```r round(case_rate_percent, 2)```% der Münsteraner*innen).

Insgesamt sind seit März 2020 ```r total_cases``` Personen an COVID-19 erkrankt, wobei davon insgesamt etwa ```r total_recovered```[\(^1\)](#fn1) Personen wieder genesen und ```r total_deceased``` verstorben sind. Die Todesrate beträgt für Münster ```r round(death_rate_percent, 2)```%.

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
df.gemeldet <- openxlsx::read.xlsx(
    "meta_data/Fallzahlen_Kum_Tab.xlsx",
    #sheetName = "LK_7-Tage-Inzidenz",
    sheet = 7,
    detectDates = FALSE
)
df.gemeldet <- df.gemeldet[2:length(df.gemeldet)]
list.dates <- strptime(df.gemeldet[1,3:length(df.gemeldet)], "%d.%m.%Y")
list.dates <- c(
    as.numeric(list.dates[!is.na(list.dates)]),
    as.numeric(as.POSIXct(as.numeric(df.gemeldet[1,3:length(df.gemeldet)][is.na(list.dates)]) * (60*60*24), origin="1899-12-30", tz="GMT"))
)
list.dates <- c("county_name", "county_id", list.dates)
df.gemeldet <- df.gemeldet[2:nrow(df.gemeldet),]
names(df.gemeldet) <- as.character(list.dates)
df.gemeldet <- df.gemeldet %>% 
    mutate(across(-c(county_name, county_id), as.numeric)) %>% 
    tidyr::pivot_longer(-c(county_name, county_id), names_to = "Meldedatum_date", values_to = "gemeldet") %>% 
    filter(county_id %in% as.character(as.numeric(county_list))) %>% 
    mutate(Meldedatum_date = lubridate::as_date(as.POSIXlt(as.numeric(Meldedatum_date)-(60*60*24), origin="1970-01-01", tz="Europe/Berlin"))) %>% 
    select(-county_id) %>% 
    left_join(
        select(df, county_name, Meldedatum_date, sieben_tage_inzidenz),
        by = c("Meldedatum_date", "county_name")
    ) %>% 
    rename(
        i_calculated = sieben_tage_inzidenz,
        i_reported = gemeldet
    )

df.notbremse <- df.gemeldet %>% 
  group_by(county_name) %>% 
  arrange(desc(Meldedatum_date)) %>% 
  slice(1:3) %>% 
  summarise(notbremse = sum(i_reported > 100)==3) %>% 
  mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
  mutate(notbremse = ifelse(notbremse, "gilt", "gilt nicht"))

df.notbremse <- left_join(
  df.gemeldet %>% 
      arrange(county_name, desc(Meldedatum_date)) %>% 
      mutate(is_over_100 = i_reported > 100) %>% 
      group_by(county_name) %>% 
      group_map(~ c(unique(.x$county_name), match(FALSE, .x$is_over_100)), .keep = TRUE) %>% do.call(rbind, .) %>% as.data.frame(),
  df.gemeldet %>% 
      arrange(county_name, desc(Meldedatum_date)) %>% 
      mutate(is_over_100 = i_calculated > 100) %>% 
      group_by(county_name) %>% 
      group_map(~ c(unique(.x$county_name), match(FALSE, .x$is_over_100)), .keep = TRUE) %>% do.call(rbind, .) %>% as.data.frame(),
  by = "V1"
) %>% 
  rename(county_name = V1, reported = V2.x, calculated = V2.y) %>% 
  mutate(reported = as.numeric(reported)-1) %>% 
  mutate(calculated = as.numeric(calculated)-1) %>% 
  mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
  left_join(df.notbremse, by = "county_name")

df.meta %>% select(
  county_name, 
  cases7_per_100k, 
  current_cases,
  case_rate_percent,
  death_rate_percent,
  total_cases, 
  total_recovered, 
  total_deceased,
) %>% 
  mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
  mutate(across(c(death_rate_percent, case_rate_percent, cases7_per_100k), ~ format(round(.x, 2), nsmall = 2))) %>% 
  left_join(df.notbremse, by = "county_name") %>% 
  relocate(notbremse, .after = county_name) %>% 
  reactable(
    compact = TRUE, borderless = TRUE, striped = TRUE, highlight = TRUE,
    columns = list(
      county_name = colDef(name = "Name", minWidth = 120, align = "left"),
      notbremse = colDef(name = "Notbremse", align = "center"),
      cases7_per_100k = colDef(name = "7-Tage-Inzidenz", align = "right"),
      current_cases = colDef(name = "Aktuelle Fälle", align = "right"),
      case_rate_percent = colDef(name = "Inzidenz", align = "right"),
      death_rate_percent = colDef(name = "Todesrate", align = "right"),
      total_cases = colDef(name = "Fälle", align = "right"),
      total_recovered = colDef(name = "Genesen", align = "right"),
      total_deceased = colDef(name = "Verstorben", align = "right"),
      calculated = colDef(name = "Errechnet", align = "right"),
      reported = colDef(name = "Gemeldet", align = "right")
    ),
    columnGroups = list(
      colGroup(name = "Insgesamt", columns = c("total_cases", "total_recovered", "total_deceased")),
      colGroup(name = "Tage mit Inzidenz > 100", columns = c("calculated", "reported", "total_deceased"))
    )
  )
```

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
ggplotly(fig.inzidenz, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% 
  plotly::config(displayModeBar = FALSE) %>% 
  plotly::style(visible="legendonly", traces = c(4,5,6,7,9,10)) %>% 
  plotly::layout(legend = list(orientation = "h", x = 0, y = -0.3))
# ggplotly(fig.cases, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% 
#  plotly::config(displayModeBar = FALSE) %>% 
#  plotly::layout(legend = list(orientation = "h", x = 0, y = -0.3))
```

```{r, include=FALSE, echo=FALSE}
fig.notbremse <- df.gemeldet %>% 
    filter(Meldedatum_date >= (as_date(now())-15)) %>% 
    filter(county_name == "SK Münster") %>% 
    #filter(!is.na(i_calculated)) %>% 
    mutate(county_name = stringr::str_replace(county_name, regex(".* "), "")) %>% 
    ggplot() +
    geom_bar(
        aes(fill = i_reported > 100, y = i_reported, x = Meldedatum_date),
        stat = "identity"
    ) +
    scale_fill_manual(values = c("#a55757", "#8e0404")) +
    geom_point(
        aes(
            x = Meldedatum_date, 
            y = i_calculated,
            fill = i_calculated > 100,
            color = i_calculated > 100),
        shape = 23
    ) +
    geom_hline(yintercept = 100, color = "black", size = 0.25) +
    scale_color_manual(values = c("#a58484", "#330101")) +
    #facet_grid(vars(county_name)) +
    labs(
        title = "Gemeldete und errechnete 7-Tage-Inzidenz für Münster",
        y = "7-Tage-Inzidenz",
        x = "Datum (Woche)",
        color = "",
        fill = ""
    ) +
    theme_minimal()
```

## Notbremse

Die Notbremse ```r df.notbremse[df.notbremse["county_name"] == "Münster","notbremse"]``` für Münster. Laut den täglich gemeldeten Daten liegt die 7-Tage-Inzidenz für Münster seit ```r df.notbremse[df.notbremse["county_name"] == "Münster","reported"]``` Tagen über 100. Laut der vom RKI berechneten Daten (inklusiver der nachgemeldeten Fälle), liegt die 7-Tage-Inzidenz für Münster seit ```r df.notbremse[df.notbremse["county_name"] == "Münster","calculated"]``` Tagen über 100.

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
ggplotly(fig.notbremse, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% 
    plotly::config(displayModeBar = FALSE) %>% 
    plotly::layout(
        showlegend = FALSE,
        selectdirection = "h",
        title = list(text = paste0('Gemeldete und errechnete 7-Tage-Inzidenz für Münster',
                                    '<br>',
                                    '<sup>',
                                    'Gemeldete Inzidenz als Balken und und errechnete Inzidenz als Rauten',
                                    '</sup>'))
    )
````

## Deutschlandweite Trends

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
ggplotly(fig.gender, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% 
    plotly::config(displayModeBar = FALSE) %>% 
    plotly::layout(legend = list(orientation = "h", x = 0, y = -0.1))
````
Das RKI aggregiert Fälle nach sechs Altersgruppen (A00-A04, A05-A14, A15-A34, A35-A59, A60-A79, A80+). Das tatsächliche Alter der Infizierten kann daher nur geschätzt werden. Das geschieht hier über das theoretische Durchschnittsalter der jeweiligen Altersgruppen (unter Annahme einer gleichmäßigen Verteilung des Alters innerhalb der Gruppe). Für die Altersgruppe "A80+" wird der obere Range der Gruppe auf 99 Jahren gesetzt. So kann für jeden Tag, bei angemessener Fallzahl (n > 100), ein durchschnittliches Alter der gemeldeten Infizierten errechnet werden.

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
ggplotly(fig.mean_age, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% 
    plotly::config(displayModeBar = FALSE) %>% 
    plotly::layout(legend = list(orientation = "h", x = 0, y = -0.1))
```

<hr>

Alle Daten stammen aus dem [COVID-19 Datenhub](https://npgeo-corona-npgeo-de.hub.arcgis.com), aktueller Stand: `r df.meta[df.meta$county_name == "SK Münster", "last_updated"]`. Es werden Zahlen aus den Datensätzen [RKI COVID19](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0) und [RKI Corona Landkreise](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/917fc37a709542548cc3be077a786c17_0) berichtet.

[^note_estimated]: Die Anzahl der genesenen Personen und damit auch die Anzahl der aktuell infizierten Personen wird nur geschätzt, da das Ende einer Infektion nicht gemeldet wird. (s.h. [Disclaimer zu Genesenen](https://www.arcgis.com/home/item.html?id=f10774f1c63e40168479a1feb6c7ca74))

