---
title: "COVID-MS"
author: "Tim Schatto-Eckrodt"
output: 
    html_document:
      css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, echo=FALSE}
library(readr)
library(magrittr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(scales)

county_list <- unique(unlist(lapply(stringr::str_split(list.files("meta_data"), pattern = "_"), `[`, 1)))
df.meta <- data.frame()
for (county in county_list) {
    if (county != "RKI") {
    meta_json <- jsonlite::read_json(paste0("meta_data/", county, "_meta.json"))
    population <- meta_json$features[[1]]$attributes$EWZ
    cases7_per_100k <- meta_json$features[[1]]$attributes$cases7_per_100k
    county_name <- meta_json$features[[1]]$attributes$county
    last_updated <- meta_json$features[[1]]$attributes$last_update
    last_updated <- substr(last_updated, 1, 10)
    df.meta <- rbind(df.meta, c(
        "county_id"=county,
        "county_name"=county_name,
        "population"=population,
        "cases7_per_100k"=cases7_per_100k,
        "last_updated"=last_updated
    ))
    }
}
names(df.meta) <- c("county_id", "county_name", "population", "cases7_per_100k", "last_updated")

RKI_COVID19 <- read_csv("meta_data/RKI_COVID19.csv")

df <- RKI_COVID19 %>% 
    filter(IdLandkreis %in% c("05515", "05913", "14713")) %>% 
    mutate(Meldedatum = lubridate::parse_date_time(Meldedatum, "%Y/%m/%d %H:%M:%S")) %>% 
    mutate(Meldedatum_date = lubridate::date(Meldedatum)) %>% 
    filter(NeuerFall >= 0) %>% 
    dplyr::group_by(Meldedatum_date, Landkreis) %>% 
    summarise(
        cases = sum(AnzahlFall),
        deaths = sum(AnzahlTodesfall),
        recovered = sum(AnzahlGenesen),
        .groups = "drop"
    ) %>% 
    rename(county_name = Landkreis) %>% 
    select(
        county_name,
        Meldedatum_date,
        cases,
        deaths,
        recovered
    )

df <- left_join(data.frame(Meldedatum_date = seq(min(df$Meldedatum_date), max(df$Meldedatum_date), by="days")) %>% dplyr::slice(rep(1:n(), 3)) %>% arrange(Meldedatum_date) %>% mutate(county_name = rep(df.meta$county_name, n()/3)), df, by = c("Meldedatum_date", "county_name")) %>% mutate(across(where(is.numeric), ~ tidyr::replace_na(.x, 0))) %>% 
    left_join(df.meta, by = c("county_name")) %>% 
    mutate(population = as.numeric(population)) %>% 
    group_by(county_name) %>% 
    arrange(Meldedatum_date) %>% 
    mutate(i = zoo::rollsum(cases, k = 7, align = "right", fill = 0)) %>% 
    mutate(i = (i/population)*100000) %>% 
    mutate(across(c(cases, deaths, recovered), cumsum, .names = "{col}_kum")) %>% 
    arrange(desc(Meldedatum_date)) %>% 
    ungroup() %>% 
    rename(sieben_tage_inzidenz = i)

total_cases <- sum(df[df$county_name == "SK Münster", "cases"])
total_deceased <- sum(df[df$county_name == "SK Münster", "deaths"])
total_recovered <- sum(df[df$county_name == "SK Münster", "recovered"])
current_cases <- total_cases - (total_deceased + total_recovered)
death_rate_percent <- (total_deceased/total_cases)*100

fig.inzidenz <- df %>% 
    rename(Datum = Meldedatum_date) %>%
    ggplot(aes(x = Datum, y = sieben_tage_inzidenz, color = county_name)) +
    geom_hline(yintercept = 50, color = "#bf0000", size = 0.25) +
    geom_hline(yintercept = 35, color = "#e80000", size = 0.25) +
    geom_line() +
    labs(
        title = "7-Tage-Inzidenz über Zeit",
        y = "7-Tage-Inzidenz",
        x = "Datum",
        color = "Stadt"
    ) +
    theme_minimal()

fig.cases <- df %>% 
    filter(county_name == "SK Münster") %>% 
    pivot_longer(ends_with("_kum")) %>% 
    mutate(name = factor(
        name, 
        levels = c("cases_kum", "recovered_kum", "deaths_kum"),
        labels = c("Fälle", "Genesen", "Verstorben")
    )) %>% 
    rename(Datum = Meldedatum_date) %>%
    ggplot(aes(x = Datum, y = value, fill = name)) +
    geom_area(position = position_dodge(width = 1)) +
    scale_fill_manual(values = c("#e41a1c", "#4daf4a", "black")) +
    labs(
        title = "Kumulierte Fälle in Münster über Zeit",
        y = "Kumulierte Fälle",
        x = "Datum",
        fill = "Typ"
    ) +
    theme_minimal()
```

Das RKI meldet eine 7-Tage-Inzidenz für Münster von ```r round(as.numeric(df.meta[df.meta$county_name == "SK Münster", "cases7_per_100k"]), 2)```[^note_differences]. Es sind gerade etwa ```r current_cases```[^note_estimated] Personen an COVID-19 erkrankt.

Insgesamt sind seit März 2020 ```r total_cases``` Personen an COVID-19 erkrankt, wobei davon ingesamt etwa ```r total_recovered```[\(^1\)](#fn1) Personen wieder genesen und ```r total_deceased``` verstorben sind. Die Todesrate beträgt für Münster ```r death_rate_percent```%.

```{r echo=FALSE, out.width = "98%", out.height= "350px"}
ggplotly(fig.inzidenz, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% plotly::config(displayModeBar = FALSE) %>% plotly::style(visible="legendonly", traces = c(3,4))
ggplotly(fig.cases, tooltip = c("x", "y"), dynamicTicks = TRUE) %>% plotly::config(displayModeBar = FALSE)
```

<hr>

Alle Daten stammen aus dem [COVID-19 Datenhub](https://npgeo-corona-npgeo-de.hub.arcgis.com), aktueller Stand: `r df.meta[df.meta$county_name == "SK Münster", "last_updated"]`

[^note_estimated]: Die Anzahl der genesenen Personen und damit auch die Anzahl der aktuell infizierten Personen wird nur geschätzt, da das Ende einer Infektion nicht gemeldet wird. (s.h. [Disclaimer zu Genesenen](https://www.arcgis.com/home/item.html?id=f10774f1c63e40168479a1feb6c7ca74))

[^note_differences]: Hier werden Zahlen aus den Datensätzten [RKI COVID19](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0) und [RKI Corona Landkreise](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/917fc37a709542548cc3be077a786c17_0) berichtet. Die 7-Tage-Inzidenz aus den beiden Datensätzen stimmt nicht immer überein.
